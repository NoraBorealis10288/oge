@page "/uniqueaccesses"
@rendermode InteractiveServer

<PageTitle>Info Page</PageTitle>

<p class="title"><b>Unique Door Accesses</b></p>
<hr>

<div class="content">
    @if (Shared.uploadStatus.Equals("file")) {
        Init();

        <h4>Top 10 Days With Most Accesses by Unique Users</h4>

        <table>
            <thead>
                <th>Door</th>
                <th>Unique Accesses</th>
                <th>Date</th>
            </thead>
            <tbody>
                @for (int i=0; i<10; i++) {
                    <tr>
                        <td>@Shared.dict[data[i][0].GetID()][0].GetDesc().Substring(22)</td>
                        <td>@data[i].Count</td>
                        <td>@DateTime.Parse(data[i][0].GetTimestamp()).Date.ToString().Substring(0,DateTime.Parse(data[i][0].GetTimestamp()).Date.ToString().IndexOf(" 12:"))</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<style>

hr {
    border-top: 5px solid #000;
    opacity: 1;
    width: 80%;
    margin: auto;
}

.title {
    font-size: 70px;
    font-family: 'Courier New', monospace;
}

.content {
    text-align: center;
}

table, th, td {
  border: 1px solid black;
}

table {
    width: 50%;
    margin: auto;
}

th {
    background-color: #6b6c70;
    color: #ffffff;
}

</style>

@code {
    Dictionary<(int door, DateTime day),List<ReaderEvent>> localDict;
    List<List<ReaderEvent>> data = new();
    public void Init() {
        localDict = ProcessDictionary(Shared.dict);
        foreach (KeyValuePair<(int,DateTime),List<ReaderEvent>> kvp in localDict) {
            data.Add(kvp.Value);
        }
        data.Sort( (x,y) => y.Count.CompareTo(x.Count) );
    }

    public Dictionary<(int door, DateTime day),List<ReaderEvent>> ProcessDictionary(Dictionary<int, List<ReaderEvent>> dict) {
        Dictionary<(int door, DateTime day),List<ReaderEvent>> tempDict = new();
        List<ReaderEvent> tempList = new();

        // loop through all doors in master dictionary, finding each unique combination of doorID and day
        // and adding it as a key in the slave dictionary, with a list of the relevant readerevents as the value
        foreach (KeyValuePair<int, List<ReaderEvent>> kvp in dict) {
            foreach (ReaderEvent reader in kvp.Value) {
                if (!tempDict.ContainsKey((kvp.Key, DateTime.Parse(reader.GetTimestamp()).Date))) {
                    tempDict.Add( (kvp.Key, DateTime.Parse(reader.GetTimestamp()).Date), new List<ReaderEvent>() );
                }
                tempDict[ ( kvp.Key, DateTime.Parse(reader.GetTimestamp()).Date) ].Add(reader);
            }
        }

        // loop through all unique keys in slave dictionary, overwriting the value with
        // the results of calling ProcessList on that value dictionary values are read-only,
        // so I'm using this weird workaround to achieve the same thing
        foreach (KeyValuePair<(int,DateTime),List<ReaderEvent>> kvp in tempDict) {
            tempList = ProcessList(kvp.Value);
            kvp.Value.Clear();
            foreach (ReaderEvent reader in tempList) { kvp.Value.Add(reader); }
        }
        return tempDict;
    }

    public List<ReaderEvent> ProcessList(List<ReaderEvent> list) {
        // Sort list by id hash
        list.Sort( (x,y) => String.Compare(x.GetHash(),y.GetHash()) );

        // Remove duplicate hashes
        var tempList = new List<ReaderEvent>();
        tempList.Add(list[0]);
        if (list.Count >= 2) {
            for (int i=1; i<list.Count; i++) {
                if (!list[i-1].GetHash().Equals(list[i].GetHash())) {
                    tempList.Add(list[i]);
                }
            }
        }
        return tempList;
    }
}